// client/src/pages/MedicalDietsHub.tsx
import { useMemo, useState } from "react";
import { useLocation } from "wouter";
import { Card, CardHeader, CardTitle, CardContent } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Badge } from "@/components/ui/badge";
import { Separator } from "@/components/ui/separator";
import {
  Select,
  SelectTrigger,
  SelectValue,
  SelectContent,
  SelectItem,
} from "@/components/ui/select";
import {
  ArrowLeft,
  ArrowUp,
  ArrowRight,
  Stethoscope,
  Droplets,
  Soup,
  Blend,
  BarChart3,
  ShoppingCart,
  Heart,
  Users,
  Apple,
} from "lucide-react";
import { ACCENTS } from "@/lib/accents";
import { useToast } from "@/hooks/use-toast";
import { queryClient } from "@/lib/queryClient";
import BuilderDayBoard from "@/components/BuilderDayBoard";
import { useBuilderPlan } from "@/hooks/useBuilderPlan";
import type { BuilderPlanJSON, PlanDay } from "@/lib/builderPlansApi";
import { FeatureInstructions } from "@/components/FeatureInstructions";
import MacroBridgeButton from "@/components/biometrics/MacroBridgeButton";
import ShoppingAggregateBar from "@/components/ShoppingAggregateBar";
import { HORMONE_LIFE_STAGES_ENABLED } from "@/features/hormoneFeatureFlag";
import { getAllHormonePresets } from "@/data/hormoneLifeStages";

/** -------------------- Types -------------------- */
type DietKey =
  | "clear_liquid"
  | "full_liquid"
  | "pureed"
  | "soft"
  | "bariatric_stage2"
  | "bariatric_stage3"
  | "anti_inflammatory"
  | "renal"
  | "cardiac"
  | "low_residue";

type Item = {
  id: string;
  name: string;
  type: "shake" | "soup" | "broth" | "pudding" | "yogurt" | "puree";
  kcal: number;
  protein: number;
  carbs: number;
  fat: number;
  tags: string[];
  notes?: string;
};

type Protocol = {
  key: DietKey;
  label: string;
  defaultFeedings: number;
  guidance: string;
  allowedTypes: Item["type"][];
  defaultHydration: string;
};

type ExportSlot = {
  time: string;
  items: Array<{
    id: string;
    name: string;
    type: Item["type"];
    kcal: number;
    protein: number;
    carbs: number;
    fat: number;
    notes?: string;
  }>;
  totals: { kcal: number; protein: number; carbs: number; fat: number };
};

type ExportPlan = {
  source: "medical-diets-hub";
  diet: DietKey;
  feedings: number;
  kcalTarget: number;
  proteinTarget: number;
  flavorPrefs: string[];
  flags: { dairyFree: boolean; lactoseFree: boolean; lowSodium: boolean };
  slots: ExportSlot[];
  totals: { kcal: number; protein: number; carbs: number; fat: number };
  createdAt: string;
};

/** -------------------- Data: Protocols -------------------- */
const PROTOCOLS: Protocol[] = [
  {
    key: "clear_liquid",
    label: "Clear Liquid",
    defaultFeedings: 6,
    guidance:
      "Clear broths, electrolyte drinks, diluted juices (no pulp), clear protein drinks. No dairy or solid particles.",
    allowedTypes: ["broth"],
    defaultHydration:
      "Sip clear fluids throughout the day; aim â‰ˆ 64 oz total unless restricted.",
  },
  {
    key: "full_liquid",
    label: "Full Liquid",
    defaultFeedings: 6,
    guidance:
      "Liquids you can pour: shakes, cream soups (strained), broths. Include protein-first choices.",
    allowedTypes: ["shake", "soup", "broth", "pudding", "yogurt"],
    defaultHydration:
      "Hydrate between feedings; avoid drinking 15â€“30 min before/after if advised.",
  },
  {
    key: "pureed",
    label: "Pureed",
    defaultFeedings: 5,
    guidance:
      "No chewing required: smooth purees (no chunks), blended meals. Protein first.",
    allowedTypes: ["puree", "soup", "pudding", "yogurt", "shake"],
    defaultHydration:
      "Slow sips across the day; separate liquids from meals if instructed.",
  },
  {
    key: "soft",
    label: "Soft / Mechanical Soft",
    defaultFeedings: 5,
    guidance:
      "Very tender, easy-to-chew foods; in this hub we emphasize soups/purees + soft puddings/yogurts.",
    allowedTypes: ["soup", "puree", "pudding", "yogurt", "shake"],
    defaultHydration: "Hydrate evenly; small sips between meals.",
  },
  {
    key: "bariatric_stage2",
    label: "Bariatric Stage 2 (Full Liquids)",
    defaultFeedings: 6,
    guidance:
      "Small volumes, high protein, low sugar. Lactose-free options often preferred. Follow your surgeonâ€™s protocol.",
    allowedTypes: ["shake", "broth", "soup", "pudding", "yogurt"],
    defaultHydration:
      "Sips every 5â€“10 minutes; do not chug. Follow clinic guidance.",
  },
  {
    key: "bariatric_stage3",
    label: "Bariatric Stage 3 (Pureed/Soft)",
    defaultFeedings: 5,
    guidance:
      "Smooth purees, slow pace, protein-first. Avoid chunks and tough fibers.",
    allowedTypes: ["puree", "soup", "pudding", "yogurt", "shake"],
    defaultHydration: "Separate fluids from meals per surgeonâ€™s rules.",
  },
  {
    key: "anti_inflammatory",
    label: "Anti-Inflammatory Diet",
    defaultFeedings: 5,
    guidance:
      "Omega-3 rich foods, colorful fruits/vegetables, herbs & spices. Reduce processed foods, refined sugars, and excess omega-6 oils.",
    allowedTypes: ["soup", "puree", "shake", "yogurt", "pudding"],
    defaultHydration:
      "Green tea, herbal teas, and water with lemon throughout the day.",
  },
  {
    key: "renal",
    label: "Renal Diet (Kidney Disease)",
    defaultFeedings: 5,
    guidance:
      "Low potassium, low phosphorus, low sodium. Control protein intake per nephrologist guidance. Essential for CKD/dialysis patients.",
    allowedTypes: ["soup", "puree", "shake", "yogurt", "pudding"],
    defaultHydration:
      "Fluid restriction often required - follow your kidney doctor's orders (typically 32-48 oz/day).",
  },
  {
    key: "cardiac",
    label: "Heart-Healthy Cardiac Diet",
    defaultFeedings: 5,
    guidance:
      "Low sodium (<2000mg/day), low saturated fat, high fiber. Omega-3 rich, whole grains. For post-MI, CHF, hypertension.",
    allowedTypes: ["soup", "puree", "shake", "yogurt", "pudding"],
    defaultHydration:
      "Adequate hydration unless CHF fluid restriction applies. Monitor sodium in all fluids.",
  },
  {
    key: "low_residue",
    label: "Low Residue Diet",
    defaultFeedings: 5,
    guidance:
      "Low fiber (<10-15g/day), easy to digest. For post-surgery, IBD flare, diverticulitis. Minimize bowel movements.",
    allowedTypes: ["soup", "puree", "shake", "yogurt", "pudding"],
    defaultHydration:
      "Stay well-hydrated with clear fluids. Avoid pulpy juices.",
  },
];

/** -------------------- Data: Items Library (curated) -------------------- */
const ITEMS: Item[] = [
  // Shakes
  {
    id: "shake-vanilla1",
    name: "Vanilla Whey Shake (water)",
    type: "shake",
    kcal: 180,
    protein: 30,
    carbs: 6,
    fat: 3,
    tags: ["vanilla", "bariatric_ok"],
  },
  {
    id: "shake-choc1",
    name: "Chocolate Whey Shake (water)",
    type: "shake",
    kcal: 190,
    protein: 30,
    carbs: 8,
    fat: 4,
    tags: ["chocolate", "bariatric_ok"],
  },
  {
    id: "shake-plant1",
    name: "Plant Protein Shake (unsweetened almond milk)",
    type: "shake",
    kcal: 210,
    protein: 25,
    carbs: 9,
    fat: 8,
    tags: ["vanilla", "dairy_free", "lactose_free", "bariatric_ok"],
  },
  {
    id: "shake-iso1",
    name: "Isolate Clear Protein Drink (citrus)",
    type: "shake",
    kcal: 90,
    protein: 20,
    carbs: 1,
    fat: 0,
    tags: ["fruit", "clear", "dairy_free", "lactose_free", "bariatric_ok"],
  },

  // Soups / Broths
  {
    id: "soup-bone1",
    name: "Bone Broth (strained)",
    type: "broth",
    kcal: 40,
    protein: 9,
    carbs: 0,
    fat: 0,
    tags: [
      "clear",
      "savory",
      "low_sodium",
      "dairy_free",
      "lactose_free",
      "bariatric_ok",
    ],
  },
  {
    id: "soup-chk1",
    name: "Creamy Chicken Soup (blended, strained)",
    type: "soup",
    kcal: 160,
    protein: 18,
    carbs: 10,
    fat: 5,
    tags: ["savory"],
  },
  {
    id: "soup-tom1",
    name: "Tomato Basil Soup (strained)",
    type: "soup",
    kcal: 140,
    protein: 6,
    carbs: 16,
    fat: 6,
    tags: ["savory", "vegetarian"],
  },

  // Purees / Yogurts / Puddings (soft)
  {
    id: "yog-greek1",
    name: "Greek Yogurt (plain, blended smooth)",
    type: "yogurt",
    kcal: 120,
    protein: 20,
    carbs: 6,
    fat: 0,
    tags: ["vanilla"],
  },
  {
    id: "pud-pro1",
    name: "High-Protein Pudding (ready-to-eat)",
    type: "pudding",
    kcal: 140,
    protein: 15,
    carbs: 6,
    fat: 4,
    tags: ["chocolate", "bariatric_ok"],
  },
  {
    id: "puree-chk",
    name: "Pureed Chicken + Broth (silky smooth)",
    type: "puree",
    kcal: 150,
    protein: 22,
    carbs: 2,
    fat: 6,
    tags: ["savory", "bariatric_ok"],
  },
  {
    id: "puree-bn",
    name: "Pureed Black Beans (thinned, strained)",
    type: "puree",
    kcal: 120,
    protein: 8,
    carbs: 17,
    fat: 1,
    tags: ["savory", "vegetarian"],
  },

  // Anti-Inflammatory Foods (15 items)
  {
    id: "ai-salmon-puree",
    name: "Pureed Wild Salmon with Olive Oil",
    type: "puree",
    kcal: 220,
    protein: 25,
    carbs: 2,
    fat: 13,
    tags: ["savory", "anti_inflammatory", "omega3"],
    notes: "Rich in omega-3 EPA/DHA",
  },
  {
    id: "ai-turmeric-soup",
    name: "Golden Turmeric Lentil Soup",
    type: "soup",
    kcal: 180,
    protein: 12,
    carbs: 24,
    fat: 4,
    tags: ["savory", "anti_inflammatory", "vegetarian"],
    notes: "Curcumin + black pepper for absorption",
  },
  {
    id: "ai-berry-smoothie",
    name: "Blueberry Ginger Smoothie",
    type: "shake",
    kcal: 160,
    protein: 8,
    carbs: 28,
    fat: 3,
    tags: ["fruit", "anti_inflammatory", "dairy_free"],
    notes: "Anthocyanins & gingerol compounds",
  },
  {
    id: "ai-greentea-yogurt",
    name: "Matcha Green Tea Yogurt",
    type: "yogurt",
    kcal: 140,
    protein: 15,
    carbs: 12,
    fat: 4,
    tags: ["anti_inflammatory", "vanilla"],
    notes: "EGCG antioxidants",
  },
  {
    id: "ai-walnut-pudding",
    name: "Walnut Chia Pudding",
    type: "pudding",
    kcal: 200,
    protein: 8,
    carbs: 18,
    fat: 12,
    tags: ["anti_inflammatory", "omega3", "dairy_free"],
    notes: "ALA omega-3 fatty acids",
  },
  {
    id: "ai-kale-puree",
    name: "Creamy Kale & White Bean Puree",
    type: "puree",
    kcal: 150,
    protein: 9,
    carbs: 20,
    fat: 4,
    tags: ["savory", "anti_inflammatory", "vegetarian"],
    notes: "Kaempferol & quercetin flavonoids",
  },
  {
    id: "ai-ginger-soup",
    name: "Carrot Ginger Coconut Soup",
    type: "soup",
    kcal: 170,
    protein: 4,
    carbs: 22,
    fat: 8,
    tags: ["savory", "anti_inflammatory", "dairy_free"],
    notes: "Beta-carotene & gingerol",
  },
  {
    id: "ai-cherry-shake",
    name: "Tart Cherry Protein Shake",
    type: "shake",
    kcal: 185,
    protein: 20,
    carbs: 18,
    fat: 4,
    tags: ["fruit", "anti_inflammatory"],
    notes: "Anthocyanins reduce inflammation markers",
  },
  {
    id: "ai-spinach-puree",
    name: "Spinach Avocado Puree",
    type: "puree",
    kcal: 160,
    protein: 6,
    carbs: 12,
    fat: 11,
    tags: ["savory", "anti_inflammatory", "vegetarian", "dairy_free"],
    notes: "Lutein & healthy monounsaturated fats",
  },
  {
    id: "ai-cacao-pudding",
    name: "Dark Cacao Anti-Inflammatory Pudding",
    type: "pudding",
    kcal: 175,
    protein: 7,
    carbs: 22,
    fat: 8,
    tags: ["chocolate", "anti_inflammatory"],
    notes: "Flavanols & polyphenols (70%+ cacao)",
  },
  {
    id: "ai-beet-soup",
    name: "Roasted Beet & Ginger Soup",
    type: "soup",
    kcal: 145,
    protein: 5,
    carbs: 26,
    fat: 3,
    tags: ["savory", "anti_inflammatory", "vegetarian"],
    notes: "Betalains & nitrates",
  },
  {
    id: "ai-pineapple-shake",
    name: "Pineapple Turmeric Smoothie",
    type: "shake",
    kcal: 155,
    protein: 10,
    carbs: 24,
    fat: 3,
    tags: ["fruit", "anti_inflammatory", "dairy_free"],
    notes: "Bromelain enzyme + curcumin",
  },
  {
    id: "ai-yogurt-berries",
    name: "Greek Yogurt with Mixed Berries",
    type: "yogurt",
    kcal: 165,
    protein: 18,
    carbs: 16,
    fat: 3,
    tags: ["anti_inflammatory", "fruit"],
    notes: "Probiotics + anthocyanins",
  },
  {
    id: "ai-broccoli-puree",
    name: "Broccoli Cauliflower Puree",
    type: "puree",
    kcal: 130,
    protein: 7,
    carbs: 18,
    fat: 4,
    tags: ["savory", "anti_inflammatory", "vegetarian"],
    notes: "Sulforaphane & indole-3-carbinol",
  },
  {
    id: "ai-tomato-soup",
    name: "Mediterranean Tomato Basil Soup",
    type: "soup",
    kcal: 155,
    protein: 6,
    carbs: 20,
    fat: 7,
    tags: ["savory", "anti_inflammatory", "vegetarian"],
    notes: "Lycopene + olive oil for absorption",
  },

  // Renal Diet Foods (15 items) - Low K, Low Phos, Low Na
  {
    id: "ren-rice-pudding",
    name: "White Rice Pudding (low phosphorus)",
    type: "pudding",
    kcal: 180,
    protein: 4,
    carbs: 35,
    fat: 3,
    tags: ["renal_safe", "low_potassium", "low_phosphorus"],
    notes: "Made with rice milk - safe for CKD",
  },
  {
    id: "ren-chicken-puree",
    name: "Leached Chicken Breast Puree",
    type: "puree",
    kcal: 165,
    protein: 28,
    carbs: 2,
    fat: 5,
    tags: ["savory", "renal_safe", "low_potassium"],
    notes: "Soaked & rinsed to remove potassium",
  },
  {
    id: "ren-apple-shake",
    name: "Apple Ginger Protein Shake",
    type: "shake",
    kcal: 170,
    protein: 15,
    carbs: 22,
    fat: 3,
    tags: ["fruit", "renal_safe", "low_potassium"],
    notes: "Apples are low-K fruit choice",
  },
  {
    id: "ren-egg-white",
    name: "Egg White Protein Pudding",
    type: "pudding",
    kcal: 140,
    protein: 18,
    carbs: 12,
    fat: 2,
    tags: ["renal_safe", "low_phosphorus", "vanilla"],
    notes: "Egg whites have less phosphorus than yolks",
  },
  {
    id: "ren-cauliflower-soup",
    name: "Leached Cauliflower Cream Soup",
    type: "soup",
    kcal: 120,
    protein: 5,
    carbs: 16,
    fat: 4,
    tags: ["savory", "renal_safe", "low_potassium", "vegetarian"],
    notes: "Double-boiled to reduce potassium",
  },
  {
    id: "ren-blueberry-yogurt",
    name: "Low-Phosphorus Blueberry Yogurt",
    type: "yogurt",
    kcal: 130,
    protein: 8,
    carbs: 18,
    fat: 3,
    tags: ["fruit", "renal_safe", "low_phosphorus"],
    notes: "Blueberries are kidney-friendly berries",
  },
  {
    id: "ren-cucumber-soup",
    name: "Chilled Cucumber Dill Soup",
    type: "soup",
    kcal: 95,
    protein: 3,
    carbs: 14,
    fat: 3,
    tags: ["savory", "renal_safe", "low_potassium", "vegetarian"],
    notes: "Cucumber is very low in potassium",
  },
  {
    id: "ren-fish-puree",
    name: "White Fish Herb Puree (low sodium)",
    type: "puree",
    kcal: 150,
    protein: 22,
    carbs: 3,
    fat: 5,
    tags: ["savory", "renal_safe", "low_sodium"],
    notes: "Fresh fish, herbs instead of salt",
  },
  {
    id: "ren-cranberry-shake",
    name: "Cranberry Vanilla Shake",
    type: "shake",
    kcal: 155,
    protein: 12,
    carbs: 20,
    fat: 3,
    tags: ["fruit", "renal_safe", "low_potassium"],
    notes: "Cranberries protect kidney function",
  },
  {
    id: "ren-cabbage-soup",
    name: "Tender Cabbage Soup (low K)",
    type: "soup",
    kcal: 110,
    protein: 4,
    carbs: 16,
    fat: 4,
    tags: ["savory", "renal_safe", "low_potassium", "vegetarian"],
    notes: "Cabbage is safe for kidney patients",
  },
  {
    id: "ren-grape-pudding",
    name: "White Grape Chia Pudding",
    type: "pudding",
    kcal: 145,
    protein: 6,
    carbs: 24,
    fat: 4,
    tags: ["fruit", "renal_safe", "low_potassium"],
    notes: "Green/white grapes are low-K",
  },
  {
    id: "ren-turkey-puree",
    name: "Ground Turkey Rice Puree",
    type: "puree",
    kcal: 175,
    protein: 20,
    carbs: 12,
    fat: 6,
    tags: ["savory", "renal_safe", "low_phosphorus"],
    notes: "Controlled protein portion for CKD",
  },
  {
    id: "ren-pear-shake",
    name: "Pear Cinnamon Protein Shake",
    type: "shake",
    kcal: 160,
    protein: 14,
    carbs: 21,
    fat: 3,
    tags: ["fruit", "renal_safe", "low_potassium"],
    notes: "Pears are excellent low-K fruit",
  },
  {
    id: "ren-zucchini-soup",
    name: "Creamy Zucchini Soup (no salt)",
    type: "soup",
    kcal: 105,
    protein: 4,
    carbs: 14,
    fat: 4,
    tags: ["savory", "renal_safe", "low_sodium", "vegetarian"],
    notes: "Zucchini is kidney-friendly vegetable",
  },
  {
    id: "ren-peach-yogurt",
    name: "Canned Peach Yogurt (low K)",
    type: "yogurt",
    kcal: 135,
    protein: 7,
    carbs: 20,
    fat: 3,
    tags: ["fruit", "renal_safe", "low_potassium"],
    notes: "Canned peaches have less K than fresh",
  },

  // Cardiac Diet Foods (15 items) - Low Na, Low Sat Fat, Heart Healthy
  {
    id: "card-oatmeal-pudding",
    name: "Steel-Cut Oat Pudding with Berries",
    type: "pudding",
    kcal: 185,
    protein: 8,
    carbs: 32,
    fat: 4,
    tags: ["cardiac_safe", "high_fiber", "whole_grain"],
    notes: "Beta-glucan fiber lowers cholesterol",
  },
  {
    id: "card-salmon-puree",
    name: "Wild Salmon Puree (no salt)",
    type: "puree",
    kcal: 210,
    protein: 26,
    carbs: 2,
    fat: 11,
    tags: ["savory", "cardiac_safe", "omega3", "low_sodium"],
    notes: "Omega-3 EPA/DHA for heart health",
  },
  {
    id: "card-berry-shake",
    name: "Triple Berry Heart-Healthy Shake",
    type: "shake",
    kcal: 175,
    protein: 15,
    carbs: 24,
    fat: 3,
    tags: ["fruit", "cardiac_safe", "antioxidant"],
    notes: "Anthocyanins support cardiovascular health",
  },
  {
    id: "card-lentil-soup",
    name: "Red Lentil Vegetable Soup (low sodium)",
    type: "soup",
    kcal: 165,
    protein: 12,
    carbs: 26,
    fat: 2,
    tags: ["savory", "cardiac_safe", "high_fiber", "vegetarian", "low_sodium"],
    notes: "Soluble fiber reduces LDL cholesterol",
  },
  {
    id: "card-avocado-puree",
    name: "Avocado Spinach Puree",
    type: "puree",
    kcal: 180,
    protein: 5,
    carbs: 14,
    fat: 13,
    tags: ["savory", "cardiac_safe", "monounsaturated", "vegetarian"],
    notes: "Healthy fats lower bad cholesterol",
  },
  {
    id: "card-greek-yogurt",
    name: "Fat-Free Greek Yogurt with Walnuts",
    type: "yogurt",
    kcal: 155,
    protein: 18,
    carbs: 14,
    fat: 4,
    tags: ["cardiac_safe", "omega3", "low_fat"],
    notes: "Walnuts provide ALA omega-3",
  },
  {
    id: "card-quinoa-pudding",
    name: "Quinoa Cinnamon Pudding",
    type: "pudding",
    kcal: 170,
    protein: 9,
    carbs: 28,
    fat: 4,
    tags: ["cardiac_safe", "whole_grain", "high_fiber"],
    notes: "Complete protein + magnesium for heart",
  },
  {
    id: "card-white-bean-soup",
    name: "Tuscan White Bean Soup (no salt)",
    type: "soup",
    kcal: 160,
    protein: 11,
    carbs: 24,
    fat: 3,
    tags: ["savory", "cardiac_safe", "high_fiber", "vegetarian", "low_sodium"],
    notes: "Fiber + folate support heart function",
  },
  {
    id: "card-flax-shake",
    name: "Blueberry Flaxseed Shake",
    type: "shake",
    kcal: 190,
    protein: 16,
    carbs: 20,
    fat: 6,
    tags: ["fruit", "cardiac_safe", "omega3"],
    notes: "Ground flax provides omega-3 ALA",
  },
  {
    id: "card-sweet-potato-puree",
    name: "Sweet Potato Ginger Puree",
    type: "puree",
    kcal: 155,
    protein: 4,
    carbs: 28,
    fat: 3,
    tags: ["savory", "cardiac_safe", "high_fiber", "vegetarian"],
    notes: "Potassium helps regulate blood pressure",
  },
  {
    id: "card-barley-soup",
    name: "Mushroom Barley Soup (low sodium)",
    type: "soup",
    kcal: 145,
    protein: 8,
    carbs: 24,
    fat: 3,
    tags: ["savory", "cardiac_safe", "whole_grain", "vegetarian", "low_sodium"],
    notes: "Beta-glucan fiber from barley",
  },
  {
    id: "card-chia-pudding",
    name: "Chia Seed Vanilla Pudding",
    type: "pudding",
    kcal: 165,
    protein: 7,
    carbs: 18,
    fat: 8,
    tags: ["cardiac_safe", "omega3", "high_fiber"],
    notes: "Chia provides omega-3 + soluble fiber",
  },
  {
    id: "card-tuna-puree",
    name: "Albacore Tuna Herb Puree (low sodium)",
    type: "puree",
    kcal: 175,
    protein: 24,
    carbs: 2,
    fat: 8,
    tags: ["savory", "cardiac_safe", "omega3", "low_sodium"],
    notes: "Lean protein + omega-3",
  },
  {
    id: "card-green-smoothie",
    name: "Heart-Healthy Green Smoothie",
    type: "shake",
    kcal: 150,
    protein: 10,
    carbs: 22,
    fat: 3,
    tags: ["cardiac_safe", "vegetarian", "antioxidant"],
    notes: "Leafy greens + nitrates support BP",
  },
  {
    id: "card-kefir-berry",
    name: "Low-Fat Kefir with Berries",
    type: "yogurt",
    kcal: 140,
    protein: 12,
    carbs: 18,
    fat: 2,
    tags: ["fruit", "cardiac_safe", "probiotic", "low_fat"],
    notes: "Probiotics may help lower cholesterol",
  },

  // Low Residue Diet Foods (15 items) - Low Fiber, Easy Digest
  {
    id: "lr-white-rice-pudding",
    name: "Creamy White Rice Pudding",
    type: "pudding",
    kcal: 190,
    protein: 5,
    carbs: 36,
    fat: 4,
    tags: ["low_residue", "low_fiber", "vanilla"],
    notes: "Refined grains - minimal residue",
  },
  {
    id: "lr-chicken-puree",
    name: "Smooth Chicken Puree (skinless)",
    type: "puree",
    kcal: 160,
    protein: 26,
    carbs: 2,
    fat: 5,
    tags: ["savory", "low_residue", "low_fiber"],
    notes: "Skinless chicken - well tolerated",
  },
  {
    id: "lr-banana-shake",
    name: "Ripe Banana Protein Shake",
    type: "shake",
    kcal: 180,
    protein: 18,
    carbs: 22,
    fat: 3,
    tags: ["fruit", "low_residue", "low_fiber"],
    notes: "Very ripe bananas are low-residue",
  },
  {
    id: "lr-egg-custard",
    name: "Vanilla Egg Custard",
    type: "pudding",
    kcal: 170,
    protein: 9,
    carbs: 20,
    fat: 6,
    tags: ["low_residue", "low_fiber", "vanilla"],
    notes: "Eggs are residue-free",
  },
  {
    id: "lr-potato-soup",
    name: "Peeled Potato Cream Soup",
    type: "soup",
    kcal: 145,
    protein: 6,
    carbs: 22,
    fat: 4,
    tags: ["savory", "low_residue", "low_fiber"],
    notes: "No skins - minimal fiber",
  },
  {
    id: "lr-refined-yogurt",
    name: "Strained Vanilla Yogurt",
    type: "yogurt",
    kcal: 135,
    protein: 12,
    carbs: 16,
    fat: 3,
    tags: ["low_residue", "low_fiber", "vanilla"],
    notes: "No fruit pieces - smooth texture",
  },
  {
    id: "lr-fish-puree",
    name: "Delicate White Fish Puree",
    type: "puree",
    kcal: 155,
    protein: 24,
    carbs: 2,
    fat: 5,
    tags: ["savory", "low_residue", "low_fiber"],
    notes: "Tender fish - easy to digest",
  },
  {
    id: "lr-refined-cereal",
    name: "Cream of Rice Pudding",
    type: "pudding",
    kcal: 175,
    protein: 4,
    carbs: 34,
    fat: 3,
    tags: ["low_residue", "low_fiber", "vanilla"],
    notes: "Refined cereal - no bran",
  },
  {
    id: "lr-melon-shake",
    name: "Honeydew Melon Smoothie",
    type: "shake",
    kcal: 165,
    protein: 14,
    carbs: 24,
    fat: 2,
    tags: ["fruit", "low_residue", "low_fiber"],
    notes: "Melon without seeds - safe choice",
  },
  {
    id: "lr-squash-soup",
    name: "Butternut Squash Soup (strained)",
    type: "soup",
    kcal: 140,
    protein: 4,
    carbs: 26,
    fat: 3,
    tags: ["savory", "low_residue", "low_fiber", "vegetarian"],
    notes: "Strained - no fiber pieces",
  },
  {
    id: "lr-turkey-puree",
    name: "Ground Turkey Puree (no skin)",
    type: "puree",
    kcal: 170,
    protein: 22,
    carbs: 3,
    fat: 7,
    tags: ["savory", "low_residue", "low_fiber"],
    notes: "Ground meat - minimal residue",
  },
  {
    id: "lr-applesauce-yogurt",
    name: "Yogurt with Smooth Applesauce",
    type: "yogurt",
    kcal: 150,
    protein: 10,
    carbs: 22,
    fat: 2,
    tags: ["fruit", "low_residue", "low_fiber"],
    notes: "No peels - refined fruit",
  },
  {
    id: "lr-noodle-soup",
    name: "Refined Noodle Broth Soup",
    type: "soup",
    kcal: 130,
    protein: 8,
    carbs: 18,
    fat: 3,
    tags: ["savory", "low_residue", "low_fiber"],
    notes: "White pasta - low residue",
  },
  {
    id: "lr-protein-shake",
    name: "Plain Vanilla Protein Shake",
    type: "shake",
    kcal: 185,
    protein: 20,
    carbs: 18,
    fat: 4,
    tags: ["low_residue", "low_fiber", "vanilla"],
    notes: "Isolate protein - no fiber added",
  },
  {
    id: "lr-canned-peach",
    name: "Canned Peach Puree",
    type: "puree",
    kcal: 125,
    protein: 2,
    carbs: 28,
    fat: 1,
    tags: ["fruit", "low_residue", "low_fiber"],
    notes: "Canned fruit - soft & low-fiber",
  },
];

/** Protein booster (virtual add-on if a slot is light) */
const BOOSTERS: Item[] = [
  {
    id: "boost-iso",
    name: "Protein Booster (half scoop isolate)",
    type: "shake",
    kcal: 60,
    protein: 12,
    carbs: 1,
    fat: 0,
    tags: ["bariatric_ok", "vanilla"],
  },
];

/** -------------------- Helpers -------------------- */
function pickItems(
  protocol: Protocol,
  feedings: number,
  _kcalTarget: number,
  proteinTarget: number,
  opts: {
    dairyFree: boolean;
    lactoseFree: boolean;
    lowSodium: boolean;
    flavors: string[];
  },
) {
  let pool = ITEMS.filter((i) => protocol.allowedTypes.includes(i.type));
  if (opts.dairyFree)
    pool = pool.filter(
      (i) => i.tags.includes("dairy_free") || i.type === "broth",
    );
  if (opts.lactoseFree)
    pool = pool.filter(
      (i) => i.tags.includes("lactose_free") || i.type === "broth",
    );
  if (opts.lowSodium)
    pool = pool.filter(
      (i) =>
        i.tags.includes("low_sodium") ||
        i.type === "shake" ||
        i.type === "yogurt",
    );

  if (opts.flavors.length > 0) {
    const favored = pool.filter((i) =>
      i.tags.some((t) => opts.flavors.includes(t)),
    );
    if (favored.length > 0) pool = favored;
  }
  if (pool.length === 0)
    pool = ITEMS.filter((i) => protocol.allowedTypes.includes(i.type));

  const out: Item[] = [];
  for (let n = 0; n < feedings; n++) {
    const pick = pool[n % pool.length];
    out.push(pick);
  }

  // Add boosters until roughly meeting protein target
  const booster = BOOSTERS[0];
  let currentProtein = out.reduce((s, i) => s + i.protein, 0);
  let safety = 0;
  while (currentProtein < proteinTarget && safety < feedings) {
    let idx = 0;
    let minP = Infinity;
    out.forEach((it, i) => {
      if (it.protein < minP) {
        minP = it.protein;
        idx = i;
      }
    });
    out.splice(idx + 1, 0, booster);
    currentProtein += booster.protein;
    safety++;
  }
  return out;
}

function timeSlots(count: number) {
  const start = 8 * 60;
  const end = 20 * 60;
  const step = Math.floor((end - start) / Math.max(1, count - 1));
  const slots: string[] = [];
  for (let i = 0; i < count; i++) {
    const mins = start + i * step;
    const hh = String(Math.floor(mins / 60)).padStart(2, "0");
    const mm = String(mins % 60).padStart(2, "0");
    slots.push(`${hh}:${mm}`);
  }
  return slots;
}

function sumProtein(list: Item[]) {
  return list.reduce((s, it) => s + it.protein, 0);
}

/** Build normalized, slot-based export (no localStorage side-effects) */
function buildExportPlan(
  plan: Item[],
  feedings: number,
  slots: string[],
  meta: {
    diet: DietKey;
    kcalTarget: number;
    proteinTarget: number;
    flavorPrefs: string[];
    flags: { dairyFree: boolean; lactoseFree: boolean; lowSodium: boolean };
  },
): ExportPlan {
  const buckets: Item[][] = Array.from({ length: feedings }, () => []);
  let i = 0;
  for (let s = 0; s < feedings && i < plan.length; s++)
    buckets[s].push(plan[i++]);
  while (i < plan.length) {
    let minIdx = 0;
    let minProtein = sumProtein(buckets[0]);
    for (let b = 1; b < buckets.length; b++) {
      const p = sumProtein(buckets[b]);
      if (p < minProtein) {
        minProtein = p;
        minIdx = b;
      }
    }
    buckets[minIdx].push(plan[i++]);
  }

  const exportSlots: ExportSlot[] = buckets.map((items, idx) => {
    const totals = items.reduce(
      (acc, it) => {
        acc.kcal += it.kcal;
        acc.protein += it.protein;
        acc.carbs += it.carbs;
        acc.fat += it.fat;
        return acc;
      },
      { kcal: 0, protein: 0, carbs: 0, fat: 0 },
    );
    return {
      time: slots[idx],
      items: items.map((it) => ({
        id: it.id,
        name: it.name,
        type: it.type,
        kcal: it.kcal,
        protein: it.protein,
        carbs: it.carbs,
        fat: it.fat,
        notes: it.notes,
      })),
      totals,
    };
  });

  const grandTotals = exportSlots.reduce(
    (acc, s) => {
      acc.kcal += s.totals.kcal;
      acc.protein += s.totals.protein;
      acc.carbs += s.totals.carbs;
      acc.fat += s.totals.fat;
      return acc;
    },
    { kcal: 0, protein: 0, carbs: 0, fat: 0 },
  );

  return {
    source: "medical-diets-hub",
    diet: meta.diet,
    feedings,
    kcalTarget: meta.kcalTarget,
    proteinTarget: meta.proteinTarget,
    flavorPrefs: meta.flavorPrefs,
    flags: meta.flags,
    slots: exportSlots,
    totals: grandTotals,
    createdAt: new Date().toISOString(),
  };
}

// Helper: Convert Item[] plan to BuilderPlanJSON
function makeDraftFromMedicalPlan(items: Item[], numDays: number): BuilderPlanJSON {
  const lists = {
    breakfast: items.filter(it => it.type === "shake" || it.type === "pudding").slice(0, 2),
    lunch: items.filter(it => it.type === "soup" || it.type === "broth").slice(0, 2),
    dinner: items.filter(it => it.type === "soup" || it.type === "shake").slice(0, 2),
    snacks: items.filter(it => it.type === "yogurt" || it.type === "puree").slice(0, 2),
  };

  const days: PlanDay[] = [];
  for (let i = 0; i < numDays; i++) {
    days.push({
      dayIndex: i,
      lists: lists,
    });
  }

  return {
    source: "medical",
    days,
    createdAtISO: new Date().toISOString(),
  };
}

/** -------------------- Page -------------------- */
export default function MedicalDietHub() {
  const [, setLocation] = useLocation();
  const { toast } = useToast();
  const ui = ACCENTS.red;
  const { query, save, update, clear } = useBuilderPlan("medical");

  const [diet, setDiet] = useState<DietKey>("full_liquid");
  const currentProtocol = useMemo(
    () => PROTOCOLS.find((p) => p.key === diet)!,
    [diet],
  );

  const [feedings, setFeedings] = useState<number>(
    currentProtocol.defaultFeedings,
  );
  const [kcalTarget, setKcalTarget] = useState<number>(1500);
  const [proteinTarget, setProteinTarget] = useState<number>(100);
  const [dairyFree, setDairyFree] = useState(false);
  const [lactoseFree, setLactoseFree] = useState(false);
  const [lowSodium, setLowSodium] = useState(false);
  const [flavors, setFlavors] = useState<string[]>([]);
  const [plan, setPlan] = useState<Item[] | null>(null);

  // Draft flow state
  const [daysCount, setDaysCount] = useState<number>(3);
  const [draft, setDraft] = useState<BuilderPlanJSON | null>(null);

  const slots = useMemo(() => timeSlots(feedings), [feedings]);
  const totals = useMemo(() => {
    if (!plan) return { kcal: 0, protein: 0, carbs: 0, fat: 0 };
    return plan.reduce(
      (acc, i) => {
        acc.kcal += i.kcal;
        acc.protein += i.protein;
        acc.carbs += i.carbs;
        acc.fat += i.fat;
        return acc;
      },
      { kcal: 0, protein: 0, carbs: 0, fat: 0 },
    );
  }, [plan]);

  function generate() {
    const out = pickItems(
      currentProtocol,
      feedings,
      kcalTarget,
      proteinTarget,
      { dairyFree, lactoseFree, lowSodium, flavors },
    );
    setPlan(out);
    // No localStorage usageâ€”per Coachâ€™s directive.
    setTimeout(
      () =>
        window.scrollTo({
          top: document.body.scrollHeight,
          behavior: "smooth",
        }),
      100,
    );
  }

  function onDietChange(next: DietKey) {
    setDiet(next);
    const p = PROTOCOLS.find((x) => x.key === next)!;
    setFeedings(p.defaultFeedings);
  }

  return (
    <div className={`min-h-screen ${ui.pageBg} p-6`}>
      {/* Back to Plan Builder Hub */}
      <button
        onClick={() => setLocation("/plan-builder-hub")}
        className="fixed top-4 left-4 z-[9999] isolate overflow-hidden rounded-2xl p-2 bg-white/10 backdrop-blur-none border border-white/30 text-white shadow-lg hover:bg-white/20 transition"
        title="Plan Builder Hub"
      >
        <ArrowLeft className="w-5 h-5" />
      </button>

      <div className="max-w-5xl mx-auto mt-16">
        {/* Header */}
        <Card
          className={`bg-black/30 backdrop-blur-xl border ${ui.cardBorder} shadow-[0_0_30px_#7c3aed33]`}
        >
          <CardHeader
            className={`bg-black/20 border-b ${ui.softBorder} rounded-t-2xl text-white`}
          >
            <div className="flex items-center gap-3">
              <Stethoscope className="w-6 h-6" />
              <CardTitle className="text-2xl">Medical Diets Hub</CardTitle>
            </div>
            <p className="text-sm text-white/80 mt-2">
              Generate safe, simple <strong>liquid / soft / pureed</strong> day
              plans fast. Not medical adviceâ€”follow your clinicianâ€™s protocol.
            </p>
          </CardHeader>
          <CardContent className="p-6 text-white">
            <FeatureInstructions
              steps={[
                "Select your medical protocol (Clear Liquid, Full Liquid, Pureed, etc.)",
                "Set your number of feedings per day (3-8 meals)",
                "Enter your daily calorie target",
                "Review the auto-generated meal plan with even timing",
                "Save to Menu Plan or send to Shopping List"
              ]}
            />
            
            {/* Controls */}
            <div className="grid md:grid-cols-2 gap-4">
              <div className="space-y-2">
                <Label>Protocol</Label>
                <Select
                  value={diet}
                  onValueChange={(v) => onDietChange(v as DietKey)}
                >
                  <SelectTrigger
                    className={`bg-black/40 border ${ui.softBorder} text-white`}
                  >
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    {PROTOCOLS.map((p) => (
                      <SelectItem key={p.key} value={p.key}>
                        {p.label}
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>
                <div className="text-xs text-white/70 bg-white/5 border border-white/10 rounded-2xl p-2">
                  {currentProtocol.guidance}
                </div>
              </div>

              <div className="space-y-2">
                <Label>Feedings per day</Label>
                <Input
                  type="number"
                  inputMode="numeric"
                  min={3}
                  max={8}
                  value={feedings}
                  onChange={(e) =>
                    setFeedings(
                      Math.max(
                        3,
                        Math.min(
                          8,
                          Number(
                            e.target.value || currentProtocol.defaultFeedings,
                          ),
                        ),
                      ),
                    )
                  }
                  className={`bg-black/40 border ${ui.softBorder} text-white`}
                />
                <div className="text-xs text-white/70">
                  Typical range 5â€“6. Evenly spaced times are auto-assigned.
                </div>
              </div>

              <div className="space-y-2">
                <Label>Daily Calories Target</Label>
                <Input
                  type="number"
                  inputMode="decimal"
                  value={kcalTarget}
                  onChange={(e) =>
                    setKcalTarget(Math.max(600, Number(e.target.value || 0)))
                  }
                  className={`bg-black/40 border ${ui.softBorder} text-white`}
                />
              </div>

              <div className="space-y-2">
                <Label>Daily Protein Target (g)</Label>
                <Input
                  type="number"
                  inputMode="decimal"
                  value={proteinTarget}
                  onChange={(e) =>
                    setProteinTarget(Math.max(40, Number(e.target.value || 0)))
                  }
                  className={`bg-black/40 border ${ui.softBorder} text-white`}
                />
                <div className="text-xs text-white/70">
                  Many protocols aim 60â€“100g/day. Confirm with your clinician.
                </div>
              </div>
            </div>

            {/* Filters */}
            <div className="mt-4 grid md:grid-cols-2 gap-4">
              <div className="bg-white/5 border border-white/10 rounded-2xl p-3">
                <div className="font-semibold mb-2">Exclusions</div>
                <div className="grid grid-cols-2 gap-2 text-sm">
                  <label className="flex items-center gap-2">
                    <input
                      type="checkbox"
                      checked={dairyFree}
                      onChange={(e) => setDairyFree(e.target.checked)}
                    />
                    Dairy-free
                  </label>
                  <label className="flex items-center gap-2">
                    <input
                      type="checkbox"
                      checked={lactoseFree}
                      onChange={(e) => setLactoseFree(e.target.checked)}
                    />
                    Lactose-free
                  </label>
                  <label className="flex items-center gap-2">
                    <input
                      type="checkbox"
                      checked={lowSodium}
                      onChange={(e) => setLowSodium(e.target.checked)}
                    />
                    Low sodium
                  </label>
                </div>
              </div>

              <div className="bg-white/5 border border-white/10 rounded-2xl p-3">
                <div className="font-semibold mb-2">Flavors</div>
                <div className="flex flex-wrap gap-2">
                  {["chocolate", "vanilla", "fruit", "savory"].map((f) => {
                    const active = flavors.includes(f);
                    return (
                      <Button
                        key={f}
                        size="sm"
                        variant={active ? "default" : "outline"}
                        onClick={() =>
                          setFlavors(
                            active
                              ? flavors.filter((x) => x !== f)
                              : [...flavors, f],
                          )
                        }
                        className={
                          active
                            ? `bg-white text-black h-8 px-3 text-sm hover:bg-white/90`
                            : `bg-black/20 border border-white/20 text-white/90 hover:text-white hover:bg-white/10 h-8 px-3 text-sm transition-all`
                        }
                      >
                        {f}
                      </Button>
                    );
                  })}
                </div>
                <div className="text-xs text-white/70 mt-2">
                  Pick none for maximum variety.
                </div>
              </div>
            </div>

            {/* Generate */}
            <div className="mt-4">
              <Button
                onClick={generate}
                className="bg-black/20 border border-white/20 text-white hover:text-white hover:bg-white/10 transition-all"
              >
                Generate Plan
              </Button>
            </div>
          </CardContent>
        </Card>

        {/* Results */}
        {plan && (
          <Card
            className={`mt-6 bg-black/30 backdrop-blur-xl border ${ui.cardBorder} shadow-[0_0_30px_#7c3aed22]`}
          >
            <CardHeader
              className={`bg-black/20 border-b ${ui.softBorder} rounded-t-xl text-white`}
            >
              <CardTitle className="text-xl">Your Day Plan</CardTitle>
              <div className="text-white/80 text-sm mt-1">
                {currentProtocol.defaultHydration}
              </div>
              <p className="text-xs text-amber-300 mt-2">
                ðŸ”’ This plan will stay here until you generate a new one.
              </p>
            </CardHeader>

            <CardContent className="p-6 text-white">
              <div className="space-y-2">
                {renderPackedSlots(plan, feedings, slots)}
              </div>

              <div className="mt-6 grid sm:grid-cols-3 gap-3">
                <Hint title="Protein-first">
                  Prioritize protein at each feeding. Weâ€™ll auto-add boosters if
                  a slot is light.
                </Hint>
                <Hint title="Small sips">
                  Hydrate slowly between feedings; avoid chugging, especially
                  for bariatric protocols.
                </Hint>
                <Hint title="Pace & feel">
                  Stop if you feel pressure, pain, or nausea. Resume with
                  smaller volumes later.
                </Hint>
              </div>
            </CardContent>
          </Card>
        )}
      </div>

      {/* Persistent Day Board */}
      <div className="mt-8">
        <BuilderDayBoard builderKey="medical" />
      </div>

      {/* Shopping Aggregate Bar */}
      {plan && plan.length > 0 && (
        <ShoppingAggregateBar
          ingredients={plan.map(item => ({
            name: item.name,
            quantity: "1",
            unit: "serving"
          }))}
          source="Medical Diets Hub"
        />
      )}
    </div>
  );
}

/** --- Slot packing (display helpers) --- */
function renderPackedSlots(plan: Item[], feedings: number, slots: string[]) {
  const buckets: Item[][] = Array.from({ length: feedings }, () => []);
  let i = 0;
  for (let s = 0; s < feedings && i < plan.length; s++) {
    buckets[s].push(plan[i++]);
  }
  while (i < plan.length) {
    let minIdx = 0;
    let minProtein = sumProtein(buckets[0]);
    for (let b = 1; b < buckets.length; b++) {
      const p = sumProtein(buckets[b]);
      if (p < minProtein) {
        minProtein = p;
        minIdx = b;
      }
    }
    buckets[minIdx].push(plan[i++]);
  }

  return (
    <div className="space-y-2">
      {buckets.map((items, idx) => {
        const slotProtein = items.reduce((s, it) => s + it.protein, 0);
        const slotKcal = items.reduce((s, it) => s + it.kcal, 0);
        return (
          <div
            key={idx}
            className="bg-white/5 border border-white/10 rounded-xl p-3"
          >
            <div className="flex items-center justify-between text-sm mb-2">
              <div className="flex items-center gap-2">
                <SlotIcon items={items} />
                <span className="font-semibold">{slots[idx]}</span>
              </div>
              <div className="text-white/80">
                {slotProtein}g â€¢ {slotKcal} kcal
              </div>
            </div>
            <div className="space-y-2">
              {items.map((it) => (
                <MedicalDietItem key={it.id} item={it} />
              ))}
            </div>
          </div>
        );
      })}
    </div>
  );
}

/** --- NEW: Ingredients & Instructions generator --- */
function getPrepForItem(item: Item): {
  ingredients: string[];
  steps: string[];
} {
  const common = {
    seasonLowSodium: "Season lightly; prefer low-sodium options.",
  };

  switch (item.type) {
    case "shake":
      return {
        ingredients: [
          "Protein powder â€“ 1 scoop",
          item.tags.includes("dairy_free") ||
          item.name.toLowerCase().includes("plant")
            ? "Unsweetened almond milk or water â€“ 8â€“12 oz"
            : "Cold water â€“ 8â€“12 oz",
          "Ice (optional)",
        ],
        steps: [
          "Add liquid to blender, then protein powder.",
          "Blend 30â€“45 seconds until silky smooth.",
          "Thin with more liquid if needed for tolerance.",
        ],
      };
    case "broth":
      return {
        ingredients: ["Bone broth â€“ 1 cup", "Water (optional) to thin"],
        steps: [
          "Heat to a gentle simmer.",
          "Strain if needed for clarity.",
          common.seasonLowSodium,
        ],
      };
    case "soup":
      return {
        ingredients: [
          "Cream/strained soup â€“ 1 cup",
          "Low-sodium broth (as needed to thin)",
        ],
        steps: [
          "Warm over low heat; do not boil.",
          "Blend and/or strain until completely smooth.",
          "Adjust thickness with broth for surgeon/clinic protocol.",
        ],
      };
    case "yogurt":
      return {
        ingredients: [
          "Plain Greek yogurt â€“ Â¾ cup",
          "Water or milk (optional) to thin",
        ],
        steps: [
          "Blend or whisk until silky smooth (no chunks).",
          "Serve chilled; thin for easier tolerance if needed.",
        ],
      };
    case "pudding":
      return {
        ingredients: ["High-protein pudding â€“ 1 serving cup"],
        steps: [
          "Chill, then stir until smooth.",
          "Optional: whisk with a tablespoon of water for looser texture.",
        ],
      };
    case "puree":
      if (item.id === "puree-chk") {
        return {
          ingredients: [
            "Cooked chicken breast â€“ 3â€“4 oz",
            "Low-sodium broth â€“ Â¼â€“Â½ cup",
          ],
          steps: [
            "Cube chicken; add to blender with broth.",
            "Blend on high until completely smooth.",
            "Strain if any fibers remain; thin to tolerance.",
          ],
        };
      }
      if (item.id === "puree-bn") {
        return {
          ingredients: [
            "Canned black beans (rinsed) â€“ Â½ cup",
            "Low-sodium broth â€“ Â¼â€“Â½ cup",
          ],
          steps: [
            "Blend beans with broth until silky smooth.",
            "Strain to remove skins if required by protocol.",
            "Thin to tolerance; re-warm gently if desired.",
          ],
        };
      }
      return {
        ingredients: [
          "Base food (well-cooked) â€“ 1 serving",
          "Low-sodium broth â€“ as needed",
        ],
        steps: [
          "Blend on high until fully smooth (no chunks).",
          "Strain if required; thin to tolerance.",
          common.seasonLowSodium,
        ],
      };
    default:
      return { ingredients: [], steps: [] };
  }
}

function MedicalDietItem({ item }: { item: Item }) {
  const prep = getPrepForItem(item);

  return (
    <div className="bg-white/5 border border-white/10 rounded-lg p-3">
      <div className="font-medium mb-1">{item.name}</div>
      <div className="text-white/70 text-xs mb-3">
        {item.type} â€¢ {item.protein}g protein â€¢ {item.carbs}g carbs â€¢ {item.fat}
        g fat â€¢ {item.kcal} kcal
        {item.notes && ` â€¢ ${item.notes}`}
      </div>

      <div className="grid sm:grid-cols-2 gap-3">
        <div>
          <div className="text-xs font-semibold mb-1">Ingredients</div>
          {prep.ingredients.length ? (
            <ul className="text-xs text-white/80 list-disc pl-4 space-y-1">
              {prep.ingredients.map((line, i) => (
                <li key={i}>{line}</li>
              ))}
            </ul>
          ) : (
            <div className="text-xs text-white/60">
              See label; keep texture smooth.
            </div>
          )}
        </div>
        <div>
          <div className="text-xs font-semibold mb-1">Cooking Instructions</div>
          {prep.steps.length ? (
            <ol className="text-xs text-white/80 list-decimal pl-4 space-y-1">
              {prep.steps.map((line, i) => (
                <li key={i}>{line}</li>
              ))}
            </ol>
          ) : (
            <div className="text-xs text-white/60">
              Follow clinic protocol for preparation.
            </div>
          )}
        </div>
      </div>

      {/* MacroBridge Button */}
      <div className="mt-3">
        <MacroBridgeButton
          meal={{
            protein: item.protein,
            carbs: item.carbs,
            fat: item.fat,
            calories: item.kcal,
            mealSlot: null,
          }}
        />
      </div>
    </div>
  );
}

function SlotIcon({ items }: { items: Item[] }) {
  const hasSavory = items.some(
    (i) =>
      i.tags.includes("savory") ||
      i.type === "soup" ||
      i.type === "broth" ||
      i.type === "puree",
  );
  const hasShake = items.some((i) => i.type === "shake");
  if (hasSavory && hasShake) return <Soup className="w-4 h-4" />;
  if (hasSavory) return <Soup className="w-4 h-4" />;
  if (hasShake) return <Blend className="w-4 h-4" />;
  return <Droplets className="w-4 h-4" />;
}

/** tiny hint card */
function Hint({
  title,
  children,
}: {
  title: string;
  children: React.ReactNode;
}) {
  return (
    <div className="bg-white/5 border border-white/10 rounded-xl p-3">
      <div className="font-semibold mb-1">{title}</div>
      <div className="text-sm text-white/80">{children}</div>
    </div>
  );
}